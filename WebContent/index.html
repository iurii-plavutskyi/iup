<html>

<head>
<link rel="import" href="svg/save.svg" />
<link rel="stylesheet" href="css/grid.css" />
<script type="text/javascript" src="js/adds/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="js/iup/Utils.js"></script>
<script type="text/javascript" src="js/iup/Layout.js"></script>
<script type="text/javascript" src="js/iup/Button.js"></script>
<script type="text/javascript" src="js/iup/Grid.js"></script>
<script type="text/javascript" src="js/iup/EventManager.js"></script>
<script type="text/javascript" src="js/iup/Store.js"></script>
<script type="text/javascript" src="js/iup/DnD.js"></script>
<script type="text/javascript" src="js/iup/Window.js"></script>
<script type="text/javascript" src="js/iup/DB.js"></script>
<script type="text/javascript" src="js/iup/Form.js"></script>
<script type="text/javascript" src="js/iup/ComboBox.js"></script>

<script type="text/javascript">
	$(document).ready( function() {
		var localSamples = [];
		var db = new iup.db.Connector({
			name : 'iup',
			upgrade : function (db) {
				/*var objectStore = */db.createObjectStore("samples", { keyPath: "id", autoIncrement : true });
			},
			onconnect : function() {
				db.list('samples', function(items) {
					localSamples = items;
					for (var i = 0; i < items.length; i++) {
						var sample = items[i];
						addLocalSampleTab(sample);
						/*var tab = createSampleTab();
						tab.cfg.items[0].value = sample.content;
						samples.addItem({title:sample.title, content : tab, closable : true, beforeclose: function(){console.log(this);}, id : sample.id});*/
					}
				});
				
				
			},
			version : 1
		});
	
		var el = new iup.layout.Element({style: {border : '1px solid', backgroundColor:'#999', width : '100px', height : '100px'}});
		var panel = new iup.layout.Panel({style: {backgroundColor:'#aff'}});
	
		
		var stretchPanel = new iup.layout.StretchPanel({
			style: {border : '1px solid #009', backgroundColor:'#fff', padding : '5px'},
			content : new iup.layout.StretchPanel({
				style: {border : '1px solid #090', backgroundColor:'#555', padding : '5px'},
				content	: panel
			})
		});
		
		function createSampleTab(url) {
			var textArea = document.createElement('textarea');
			textArea.style.width = '100%';
			textArea.style.height = '100%';
			
			textArea.onkeydown = function(e) {
				var keyCode = e.keyCode || e.which;

				if (keyCode == 9) {
					e.preventDefault();
					var start = $(this).get(0).selectionStart;
					var end = $(this).get(0).selectionEnd;

					// set textarea value to: text before caret + tab + text after caret
					$(this).val($(this).val().substring(0, start)
								+ "    "
								+ $(this).val().substring(end));

					// put caret at right position again
					$(this).get(0).selectionStart = 
					$(this).get(0).selectionEnd = start + 4;
				}
			}
			
			if (url) {
				$.ajax({
					url: url,
					dataType :'text',
					success : function(data,b,c) {
						textArea.value = data;
					}
				})
			}
		
			return new iup.layout.Panel({
				style: {
					backgroundColor:'#aaa', 
					overflow:'hidden'
				},
				items : [textArea]
			});

		}
		
		var samples = new iup.layout.TabPanel({
			items : [
				{ title : 'Tabs', content : createSampleTab('samples/Tabs.js')},
				{ title : 'Grid', content : createSampleTab('samples/Grid.js')},
				{ title : 'Window', content : createSampleTab('samples/Window.js')},
				{ title : 'Form', content : createSampleTab('samples/Form.js')}
			]
		})
		
		var execute = new iup.Button({
			text:"EXECUTE", 
			className : 'button edit',
			handler : function() {
				//console.log();
				
				var script = $(samples.disclosedItem.content.getEl()).find('textarea').val();
				
				//console.log(samples.disclosedItem);
				if (samples.disclosedItem.id) {
					for (var i = 0; i < localSamples.length; i++) {
						var sample = localSamples[i];
						if (sample.id === samples.disclosedItem.id) {
							sample.content = script;
							//console.log (sample);
							//
							db.put('samples', sample, function(id) {console.log('object saved; ID: ' + id)});
						}
					}
					
				}
				
				var exec;
				
				try{
					eval('exec = function() {' + script + '}');
				} catch (e) {
					console.log(e);
					iup.popup.Notification.notify({
						type : 'error',
						title : 'Excecution failed',
						message : e
					});
				}
				if (typeof exec === 'function') {
					var ret = exec();
					if (ret instanceof iup.layout.Panel) {
						stretchPanel.setContent(ret);
					}
				}
			}
		});
		
		var store = new iup.data.Store({
			data : [{name:"Name1", lastName:"LastName1", age : 38},
					{name:"Name2", lastName:"LastName2", age : 31},
				   // {name:"Name3", lastName:"LastName3", age : 32},
					{name:"Name4", lastName:"LastName4", age : 33}],
			autoLoad : false
			
		});
		var grid = new iup.layout.Grid({
			columns : [
			    {header : "Info", key : "name", 
			    	renderer : function(value, record) {   
			    		var ret = [];
			    		ret.push('First Name : ' + record.get('name'));
			    		ret.push('Last Name : ' + record.get('lastName'));
			    		ret.push('Age : ' + record.get('age'));
			    		return ret.join('<br/>');
			    	}
			    },
				{header : "Name", key : "name", sortable : true},
				{header : "Last Name adsasfda asdasda asd adsa adsasfda asdasda asd adsa adsasfda asdasda asd adsa", key : "lastName", width : 150},
				{header : "Age", key : "age", width : 50, fixed : true, sortable : true}       
			],
			emptyText : "no data",
			store : store,
			selectionModel : iup.layout.Grid.SELECTION_MULTI,
			handlers : { 
				cellClick : function(e,c,r) {console.log(e,c,r);}
			}
			
		});

		var updateData = new iup.Button({
			text:"Load Data", 
			className : 'button delete',
			handler : function() {
				store.loadData([
					{name:"Name5", lastName:"LastName5", age : 43},
					{name:"Name6", lastName:"LastName6", age : 44},
					{name:"Name7", lastName:"LastName7", age : 45},
					{name:"Name8", lastName:"LastName8", age : 46},
					{name:"Name9", lastName:"LastName9", age : 47}
				]);
			}
		})
		
		var masked = false;
		var maskButton = new iup.Button({
			text:"C", 
			icon : 'svg/save.svg',
			className : 'button add', 
			handler : function() {
				masked = !masked;
				updateData.mask(masked);
			}
		});
		
		var tabPanel = new iup.layout.TabPanel({
			style	: {backgroundColor:'#aff'},
			buttonsPosition : 'top',
			//buttonsSize : 150,
			items	: [
				{title : "A", icon : 'svg/save.svg',content : new iup.layout.Panel({style: {backgroundColor:'#aaf'}})},     	   
				{title : "B", content : grid}, 
				{title : "C", closable : true, content : new iup.layout.Panel({style: {backgroundColor:'#faa'}})},     	 
			]
		});
		
		function addLocalSampleTab(sample){
			var tab = createSampleTab();
			tab.cfg.items[0].value = sample.content;
			samples.addItem({
				id : sample.id,
				title:sample.title, 
				content : tab, 
				closable : true, 
				beforeclose: function(){
					db.remove('samples', sample.id, function() {
						localSamples.splice(localSamples.indexOf(sample), 1);
						console.log(localSamples);
					});
				} 
			});
		}
		
		var sampleTabName = new iup.form.Field({
			label : 'Tab Name:',
			name : 'tabName',
			required : true
		});
		var tabNameWin = new iup.popup.Window({
			width : 300,
			height : 50,
			//title : "Modal Window",
			content : new iup.form.FieldSet({
				labelWidth : 100,
				fields : [sampleTabName]
			}),
			bbar : [
				'->',
				new iup.Button ({
					text : 'OK',
					className : 'button edit',
					handler : function() {
						if (sampleTabName.validate()) {
							console.log(sampleTabName.getField().get());
							var newSample = {
								title : sampleTabName.getField().get(),
								content : ''
							} 
							db.put('samples', newSample, function(id) {
								//console.log(id, newSample);
								localSamples.push(newSample);
								addLocalSampleTab(newSample);
							});
							tabNameWin.hide();
						}
					}
				})
			]
		})
		
		var borderPanel = new iup.layout.BorderPanel({
			//style : {backgroundColor : 'red'},
			layoutConfig : {top : 150, bottom : 30, left : 500, right : 50},
			splitter : ['top','bottom', 'left', 'right'],
			top 	: tabPanel,
			bottom 	: new iup.layout.Toolbar({
				style	: {backgroundColor:'#aaf', padding : '5px'},
				marginBetweenItems : 5,
				items	: [
					execute,
					new iup.Button({
						text : "Add", 
						className : 'button edit',
						handler : function() {
							tabNameWin.show();
						}
					}),
					'->', 
					updateData,
					maskButton
		     	]
			}),
			left 	: samples,//scrollPanel,//new iup.layout.Panel({style: {backgroundColor:'#aaa'}}),
			right 	: new iup.layout.Panel({style: {backgroundColor:'#faa'}}),
			center	: stretchPanel
		});
		
		document.getElementsByTagName("body")[0].appendChild(borderPanel.getEl());
		
		new iup.layout.ViewPort({
			content : borderPanel
		});
		
		
	});
</script>

</head>
<body style="margin:0px;">

</body>
</html>